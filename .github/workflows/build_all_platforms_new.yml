name: Build All Platforms

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      build_android:
        description: 'æ„å»º Android'
        required: true
        default: true
        type: boolean
      build_ios:
        description: 'æ„å»º iOS'
        required: true
        default: true
        type: boolean
      build_macos:
        description: 'æ„å»º macOS'
        required: true
        default: true
        type: boolean
      build_windows:
        description: 'æ„å»º Windows'
        required: true
        default: true
        type: boolean
      build_linux:
        description: 'æ„å»º Linux'
        required: true
        default: true
        type: boolean
      build_tv:
        description: 'æ„å»º Android TV'
        required: true
        default: false
        type: boolean
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: true
        default: false
        type: boolean
  # æ¨é€ Tag æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.38.x'
  JAVA_VERSION: '17'

jobs:
  # ==================== Android & iOS & macOS ====================
  build-mobile-macos:
    name: Build Android + iOS + macOS
    runs-on: macos-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && (inputs.build_android || inputs.build_ios || inputs.build_macos))
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      # 2. è®¾ç½® Java ç¯å¢ƒï¼ˆAndroid éœ€è¦ï¼‰
      - name: â˜• Setup Java
        if: inputs.build_android != false
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # 3. é…ç½® Android ç­¾åï¼ˆå¦‚æœæœ‰å¯†é’¥ï¼‰
      - name: ğŸ” Setup Android Keystore
        if: inputs.build_android != false && env.HAS_KEYSTORE == 'true'
        env:
          HAS_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 != '' }}
        id: android_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: keystore.jks
          encodedString: ${{ secrets.KEYSTORE_BASE64 }}

      - name: ğŸ“ Create key.properties
        if: inputs.build_android != false && env.HAS_KEYSTORE == 'true'
        env:
          HAS_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo "storeFile=${{ steps.android_keystore.outputs.filePath }}" > simple_live_app/android/key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> simple_live_app/android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> simple_live_app/android/key.properties

      # å¦‚æœæ²¡æœ‰ç­¾åå¯†é’¥ï¼Œåˆ›å»º dummy é…ç½®
      - name: ğŸ“ Create Dummy key.properties
        if: inputs.build_android != false && env.HAS_KEYSTORE != 'true'
        env:
          HAS_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          cd simple_live_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=key0" >> key.properties
          echo "storeFile=../app/dummy.jks" >> key.properties

      # 4. è®¾ç½® Flutter ç¯å¢ƒ
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      # 5. å¯ç”¨æ¡Œé¢æ”¯æŒ
      - name: ğŸ–¥ï¸ Enable macOS Desktop
        if: inputs.build_macos != false
        run: flutter config --enable-macos-desktop

      # 6. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      # 7. å®‰è£…æ‰“åŒ…å·¥å…·
      - name: ğŸ› ï¸ Install Build Tools
        if: inputs.build_macos != false
        run: |
          npm install -g appdmg
          dart pub global activate flutter_distributor

      # 8. æ„å»º Android APK
      - name: ğŸ¤– Build Android APK
        if: inputs.build_android != false
        run: |
          cd simple_live_app
          if [ "${{ env.HAS_KEYSTORE }}" == "true" ]; then
            echo "Building release APK with signature..."
            flutter build apk --release --split-per-abi
          else
            echo "Building debug APK without signature..."
            flutter build apk --debug
          fi
        env:
          HAS_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 != '' }}

      # 9. æ„å»º iOS
      - name: ğŸ Build iOS IPA
        if: inputs.build_ios != false
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload

      # 10. æ„å»º macOS
      - name: ğŸ’» Build macOS DMG
        if: inputs.build_macos != false
        run: |
          cd simple_live_app
          flutter_distributor package --platform macos --targets dmg,zip --skip-clean

      # 11. ä¸Šä¼  Android APK
      - name: ğŸ“¤ Upload Android APK
        if: inputs.build_android != false
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            simple_live_app/build/app/outputs/flutter-apk/*.apk
          retention-days: 7

      # 12. ä¸Šä¼  iOS IPA
      - name: ğŸ“¤ Upload iOS IPA
        if: inputs.build_ios != false
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
          retention-days: 7

      # 13. ä¸Šä¼  macOS
      - name: ğŸ“¤ Upload macOS
        if: inputs.build_macos != false
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip
          retention-days: 7

  # ==================== Windows ====================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.build_windows != false)
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ–¥ï¸ Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      - name: ğŸ› ï¸ Install flutter_distributor
        run: dart pub global activate flutter_distributor

      - name: ğŸªŸ Build Windows
        run: |
          cd simple_live_app
          flutter_distributor package --platform windows --targets msix,zip --skip-clean

      - name: ğŸ“¤ Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-msix
          path: |
            simple_live_app/build/dist/*/*.msix
            simple_live_app/build/dist/*/*.zip
          retention-days: 7

  # ==================== Linux ====================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.build_linux != false)
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libasound2-dev libmpv-dev mpv

      - name: ğŸ–¥ï¸ Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: ğŸ“¦ Install Flutter Dependencies
        run: |
          cd simple_live_app
          flutter pub get

      - name: ğŸ› ï¸ Install flutter_distributor
        run: dart pub global activate flutter_distributor

      - name: ğŸ§ Build Linux
        run: |
          cd simple_live_app
          flutter_distributor package --platform linux --targets deb,zip --skip-clean

      - name: ğŸ“¤ Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: |
            simple_live_app/build/dist/*/*.deb
            simple_live_app/build/dist/*/*.zip
          retention-days: 7

  # ==================== Android TV ====================
  build-android-tv:
    name: Build Android TV
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.build_tv != false)
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: master

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“ Create Dummy key.properties
        run: |
          cd simple_live_tv_app/android
          echo "storePassword=123456" > key.properties
          echo "keyPassword=123456" >> key.properties
          echo "keyAlias=key0" >> key.properties
          echo "storeFile=../app/dummy.jks" >> key.properties

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd simple_live_tv_app
          flutter pub get

      - name: ğŸ“º Build Android TV APK
        run: |
          cd simple_live_tv_app
          flutter build apk --debug

      - name: ğŸ“¤ Upload Android TV APK
        uses: actions/upload-artifact@v4
        with:
          name: android-tv-apk
          path: simple_live_tv_app/build/app/outputs/flutter-apk/*.apk
          retention-days: 7

  # ==================== åˆ›å»º Release ====================
  create-release:
    name: Create GitHub Release
    needs: [build-mobile-macos, build-windows, build-linux, build-android-tv]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.create_release)
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“‹ List Downloaded Files
        run: |
          echo "=== Downloaded Artifacts ==="
          ls -R artifacts/

      - name: ğŸ“„ Read Version Info
        id: version
        run: |
          if [ -f "assets/app_version.json" ]; then
            VERSION=$(cat assets/app_version.json | jq -r '.version')
            DESC=$(cat assets/app_version.json | jq -r '.version_desc')
            PRERELEASE=$(cat assets/app_version.json | jq -r '.prerelease')
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            DESC="Simple Live Release ${VERSION}"
            PRERELEASE="false"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "description=${DESC}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Simple Live ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸ“¦ Simple Live ${{ steps.version.outputs.version }}

            ${{ steps.version.outputs.description }}

            ### ğŸ“¥ ä¸‹è½½è¯´æ˜

            - **Android**: ä¸‹è½½ `app-arm64-v8a-release.apk` (æ¨èï¼Œé€‚ç”¨äºå¤§å¤šæ•°è®¾å¤‡)
            - **Android TV**: ä¸‹è½½ `app-debug.apk` (TV ç‰ˆæœ¬)
            - **Windows**: ä¸‹è½½ `.msix` æˆ– `.zip` æ–‡ä»¶
            - **macOS**: ä¸‹è½½ `.dmg` æˆ– `.zip` æ–‡ä»¶
            - **Linux**: ä¸‹è½½ `.deb` æˆ– `.zip` æ–‡ä»¶
            - **iOS**: ä¸‹è½½ `ios_no_sign.ipa` (éœ€è¦è‡ªè¡Œç­¾å)

            ### âš ï¸ æ³¨æ„äº‹é¡¹

            - æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨
            - iOS ç‰ˆæœ¬æœªç­¾åï¼Œéœ€è¦è‡ªè¡Œç­¾ååå®‰è£…
            - éƒ¨åˆ†å¹³å°ç‰ˆæœ¬ä¸ºæµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜
          prerelease: ${{ steps.version.outputs.prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            artifacts/**/*.apk
            artifacts/**/*.ipa
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.msix
            artifacts/**/*.deb
          fail_on_unmatched_files: false

      - name: âœ… Release Created
        run: |
          echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
